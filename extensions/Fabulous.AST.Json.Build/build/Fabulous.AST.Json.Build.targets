<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Default to Debug if not set -->
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    
    <!-- Task assembly path - relative to the targets file location -->
    <_FabulousAstJsonTaskAssembly>$(MSBuildThisFileDirectory)..\tasks\net8.0\Fabulous.AST.Json.Build.dll</_FabulousAstJsonTaskAssembly>
  </PropertyGroup>

  <!-- Import the task assembly -->
  <UsingTask
    TaskName="Fabulous.AST.Json.Build.FabulousAstJsonTask"
    AssemblyFile="$(_FabulousAstJsonTaskAssembly)" />

  <!--
    Main generation target
    Runs before compilation to generate F# files from JSON
  -->
  <Target
    Name="FabulousAstJsonGenerate"
    BeforeTargets="BeforeCompile"
    Condition="'$(EnableFabulousAstJsonGeneration)' == 'true' AND '@(FabulousAstJson)' != ''"
    Inputs="@(FabulousAstJson)"
    Outputs="@(FabulousAstJson->'$(FabulousAstJsonOutputDir)%(Filename).Generated.fs')">

    <!-- Ensure output directory exists -->
    <MakeDir Directories="$(FabulousAstJsonOutputDir)" />

    <!-- Run the generation task -->
    <FabulousAstJsonTask
      JsonFiles="@(FabulousAstJson)"
      ProjectDirectory="$(MSBuildProjectDirectory)"
      OutputDirectory="$(FabulousAstJsonOutputDir)">

      <Output TaskParameter="GeneratedFiles" ItemName="FabulousAstJsonGeneratedFiles" />
    </FabulousAstJsonTask>

    <Message
      Importance="high"
      Text="Fabulous.AST.Json: Generated %(FabulousAstJsonGeneratedFiles.Identity)"
      Condition="'@(FabulousAstJsonGeneratedFiles)' != ''" />

  </Target>

  <!-- Clean target to remove generated files -->
  <Target Name="FabulousAstJsonClean" BeforeTargets="Clean">
    <ItemGroup>
      <_FabulousAstJsonFilesToDelete Include="$(FabulousAstJsonOutputDir)*.Generated.fs" />
    </ItemGroup>
    <Delete Files="@(_FabulousAstJsonFilesToDelete)" />
  </Target>

</Project>
