<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    <!-- Task assembly: prefer NuGet package, fall back to local build -->
    <_FabulousAstTaskDll Condition="'$(_FabulousAstTaskDll)' == ''">$(MSBuildThisFileDirectory)..\tasks\net8.0\Fabulous.AST.Build.dll</_FabulousAstTaskDll>
    <_FabulousAstTaskDll Condition="!Exists('$(_FabulousAstTaskDll)')">$(MSBuildThisFileDirectory)..\bin\$(Configuration)\net8.0\Fabulous.AST.Build.dll</_FabulousAstTaskDll>
  </PropertyGroup>

  <UsingTask TaskName="Fabulous.AST.Build.FabulousAstJsonTask" AssemblyFile="$(_FabulousAstTaskDll)" Condition="Exists('$(_FabulousAstTaskDll)')" />

  <!-- Compute effective output filename for each item -->
  <ItemGroup>
    <FabulousAstJson Update="@(FabulousAstJson)">
      <_OutputFile Condition="'%(OutputFileName)' == ''">%(Filename).$(FabulousAstJsonSuffix).fs</_OutputFile>
      <_OutputFile Condition="'%(OutputFileName)' != ''">%(OutputFileName)</_OutputFile>
    </FabulousAstJson>
  </ItemGroup>

  <!--
    STATIC ITEMGROUP: Reorder Compile items so generated files come BEFORE user source files.
    This runs at project load time (not in a target), so IDEs see the correct order.

    Steps:
    1. Save all current Compile items (user's source files)
    2. Clear the Compile list
    3. Add generated files first
    4. Re-add user's source files after
  -->
  <ItemGroup Condition="'$(EnableFabulousAstJson)' == 'true' AND '@(FabulousAstJson)' != ''">
    <!-- Step 1: Save user's source files -->
    <_FabulousAstSavedCompile Include="@(Compile)" />
    <!-- Step 2: Clear Compile list -->
    <Compile Remove="@(Compile)" />
    <!-- Step 3: Add generated files FIRST (computed from FabulousAstJson items) -->
    <Compile Include="@(FabulousAstJson->'$(FabulousAstOutputFolder)/%(_OutputFile)')" KeepDuplicates="false" />
    <!-- Step 4: Re-add user's source files AFTER generated files -->
    <Compile Include="@(_FabulousAstSavedCompile)" />
    <!-- Cleanup temporary item -->
    <_FabulousAstSavedCompile Remove="@(_FabulousAstSavedCompile)" />
  </ItemGroup>

  <!-- Main generation target: JSON -->
  <Target Name="FabulousAstJsonGenerate" BeforeTargets="BeforeCompile"
          Condition="'$(DesignTimeBuild)' != 'true' AND '$(EnableFabulousAstJson)' == 'true' AND '@(FabulousAstJson)' != '' AND Exists('$(_FabulousAstTaskDll)')"
          Inputs="@(FabulousAstJson)" Outputs="@(FabulousAstJson->'$(FabulousAstOutputPath)%(_OutputFile)')">
    <MakeDir Directories="$(FabulousAstOutputPath)" />
    <FabulousAstJsonTask
        JsonFiles="@(FabulousAstJson)"
        ProjectDirectory="$(MSBuildProjectDirectory)"
        OutputDirectory="$(FabulousAstOutputPath)"
        FabulousAstJsonSuffix="$(FabulousAstJsonSuffix)">
      <Output TaskParameter="GeneratedFiles" ItemName="_GeneratedFiles" />
    </FabulousAstJsonTask>
    <Message Importance="high" Text="Fabulous.AST.Json: Generated %(_GeneratedFiles.Identity)" Condition="'@(_GeneratedFiles)' != ''" />
  </Target>

  <!-- Warning when task assembly not found -->
  <Target Name="_FabulousAstJsonNoTask" BeforeTargets="BeforeCompile"
          Condition="'$(EnableFabulousAstJson)' == 'true' AND '@(FabulousAstJson)' != '' AND !Exists('$(_FabulousAstTaskDll)')">
    <Warning Text="Fabulous.AST.Build: Task assembly not found. Run 'dotnet restore' or build Fabulous.AST.Build first." />
  </Target>

  <!-- Clean generated files -->
  <Target Name="FabulousAstJsonClean" BeforeTargets="Clean" Condition="'@(FabulousAstJson)' != ''">
    <Delete Files="@(FabulousAstJson->'$(FabulousAstOutputPath)%(_OutputFile)')" />
  </Target>


</Project>
